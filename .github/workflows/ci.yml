name: pistonâ€‘leakâ€‘ci

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    env:
      POETRY_VIRTUALENVS_IN_PROJECT: "true"   # .venv lives in repo root
      PYTHON_KEYRING_BACKEND: "keyring.backends.null.Keyring"  # silence poetry keyring

    steps:
      - name: ğŸ“¥  Checkout repo
        uses: actions/checkout@v4

      - name: ğŸ  Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ› ï¸  Install Poetry + cache
        uses: abatilo/actions-poetry@v3
        with:
          poetry-version: "1.8.2"

      - name: ğŸ’¾  Restore Poetry cache
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('pyproject.toml', 'poetry.lock') }}

      - name: ğŸ“¦  Install project (CPUâ€‘only extras)
        run: poetry install --no-interaction --no-root

      # ---------- Quality gates ----------
      - name: ğŸ” Ruff lint
        run: poetry run ruff check .

      - name: ğŸ¨ Black formatting check
        run: poetry run black --check .

      - name: ğŸ§ª Unit tests
        run: poetry run pytest -q

      # ---------- Smoke simulation ----------
      - name: ğŸŒ€ Monteâ€‘Carlo smoke test (50 runs)
        run: |
          poetry run run-mc --config sims/baseline.yml --n 50 --out smoke_test

      - name: ğŸ“¦ Upload smoke artifacts
        uses: actions/upload-artifact@v4
        with:
          name: smoke_test_results
          path: smoke_test/

      # ---------- Humor gate ----------
      - name: ğŸ¤¡ Humor gate
        run: |
          if grep -R --ignore-case -n "todo-joke-here" *.md docs || true; then
            echo "::error::Humorless TODO detected. Insert memes before merge."
            exit 1
          fi
